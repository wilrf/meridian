# Meridian Codebase Module Map

> Generated by Agent 1: Architect/Planner
> Date: 2026-01-28

## 1. Current State Analysis

### 1.1 Components Inventory (`src/components/`)

| Component | Size | Primary Dependencies | Feature Domain |
|-----------|------|---------------------|----------------|
| `CodeRunner.tsx` | 585 LOC | `pyodide-context`, `lesson-context`, `LightEditor`, `HintSystem` | Editor |
| `ProjectWorkspace.tsx` | 472 LOC | `pyodide-context`, `use-progress`, `ProjectEditor`, `ProjectInstructions`, `ProjectOutput`, `ResizableDivider` | Projects |
| `LightEditor.tsx` | 440 LOC | `python-tokenizer`, `Autocomplete` | Editor |
| `LessonRenderer.tsx` | 331 LOC | `remark-code-meta`, `rehype-code-blocks`, `lesson-context`, `pyodide-context`, `CodeRunner`, `StaticCode`, `ErrorBoundary` | Lessons |
| `ProjectInstructions.tsx` | 315 LOC | `StaticCode` (markdown rendering) | Projects |
| `ProgressSidebar.tsx` | 212 LOC | `use-progress`, `ThemeToggle`, `AuthButton`, `MeridianLogo`, `manifest.json` | Navigation |
| `Dashboard.tsx` | 246 LOC | `use-progress`, `StatsBar`, `MeridianLogo`, `manifest.json` | Navigation |
| `ProjectEditor.tsx` | 207 LOC | `LightEditor` | Projects |
| `ProjectOutput.tsx` | 234 LOC | None (standalone) | Projects |
| `Autocomplete.tsx` | 169 LOC | None (standalone) | Editor |
| `AuthButton.tsx` | 146 LOC | `auth-context` | Auth |
| `HintSystem.tsx` | 129 LOC | None (standalone) | Lessons |
| `StaticCode.tsx` | 106 LOC | `python-tokenizer` | Editor |
| `ResizableDivider.tsx` | 104 LOC | None (standalone) | Shared UI |
| `PyodideStatus.tsx` | 68 LOC | `pyodide-context` | Editor |
| `PyodidePreloader.tsx` | 32 LOC | `pyodide-context` | Editor |
| `PyodideProvider.tsx` | 23 LOC | `pyodide-context` | Editor |
| `LessonNav.tsx` | 66 LOC | None (standalone) | Lessons |
| `ErrorBoundary.tsx` | 58 LOC | None (standalone) | Shared UI |
| `MeridianLogo.tsx` | 90 LOC | None (standalone) | Shared UI |
| `StatsBar.tsx` | 53 LOC | None (standalone) | Navigation |

**UI Primitives (`src/components/ui/`):**
- `Button.tsx` - Variant-based button component
- `Card.tsx` - Card with variants (default, hover, interactive, elevated)
- `Input.tsx` - Input component
- `ThemeToggle.tsx` - Theme toggle using `theme-context`

### 1.2 Utilities Inventory (`src/lib/`)

| File | Purpose | Dependencies | Feature Domain |
|------|---------|--------------|----------------|
| `pyodide-context.tsx` | Pyodide WebAssembly runtime management | None | Editor (Core) |
| `auth-context.tsx` | GitHub OAuth authentication | `supabase/client` | Auth |
| `theme-context.tsx` | Light/Dark theme management | None | Shared |
| `lesson-context.tsx` | Lesson ID context for exercises | None | Lessons |
| `use-progress.ts` | Progress routing (cloud/local) | `auth-context`, `cloud-progress`, `progress` types | Progress |
| `cloud-progress.ts` | Supabase cloud progress sync | `supabase/client`, `progress` types | Progress |
| `progress.ts` | Local file-based progress (server-side) | None | Progress |
| `python-tokenizer.ts` | Python syntax tokenization | None | Editor |
| `lessons.ts` | Lesson file loading (server-side) | None | Lessons |
| `utils.ts` | `cn()` utility for Tailwind | None | Shared |
| `remark-code-meta.ts` | Remark plugin for code blocks | None | Lessons |
| `rehype-code-blocks.ts` | Rehype plugin for interactive code | None | Lessons |
| `supabase/client.ts` | Browser Supabase client | None | Shared |
| `supabase/server.ts` | Server Supabase client | None | Shared |
| `supabase/middleware.ts` | Supabase session middleware | None | Shared |

### 1.3 Dependency Graph

```
                                ┌─────────────────────────────────────────────┐
                                │               APP LAYER                      │
                                │  layout.tsx, lessons/page, projects/page    │
                                └─────────────────┬───────────────────────────┘
                                                  │
                     ┌────────────────────────────┼────────────────────────────┐
                     │                            │                            │
                     ▼                            ▼                            ▼
          ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
          │   LESSONS        │         │    PROJECTS      │         │   NAVIGATION     │
          │                  │         │                  │         │                  │
          │ LessonRenderer   │         │ ProjectWorkspace │         │ ProgressSidebar  │
          │ LessonNav        │         │ ProjectEditor    │         │ Dashboard        │
          │ HintSystem       │         │ ProjectOutput    │         │ StatsBar         │
          │                  │         │ ProjectInstruct  │         │                  │
          └────────┬─────────┘         └────────┬─────────┘         └────────┬─────────┘
                   │                            │                            │
                   │ ┌──────────────────────────┼────────────────────────────┤
                   │ │                          │                            │
                   ▼ ▼                          ▼                            ▼
          ┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
          │    EDITOR        │         │    PROGRESS      │         │      AUTH        │
          │                  │         │                  │         │                  │
          │ CodeRunner       │         │ use-progress.ts  │         │ auth-context     │
          │ LightEditor      │         │ cloud-progress   │         │ AuthButton       │
          │ Autocomplete     │         │ progress.ts      │         │                  │
          │ StaticCode       │         │                  │         │                  │
          │ pyodide-context  │         └────────┬─────────┘         └────────┬─────────┘
          │ python-tokenizer │                  │                            │
          │ PyodideProvider  │                  │                            │
          │ PyodideStatus    │                  ▼                            ▼
          │ PyodidePreloader │         ┌─────────────────────────────────────┐
          └──────────────────┘         │           SUPABASE                  │
                                       │  client.ts, server.ts, middleware   │
                                       └─────────────────────────────────────┘
                   │
                   │
                   ▼
          ┌──────────────────────────────────────────────────────────────────┐
          │                        SHARED                                    │
          │                                                                  │
          │  UI: Button, Card, Input, ThemeToggle, ErrorBoundary,           │
          │      ResizableDivider, MeridianLogo                             │
          │                                                                  │
          │  Utils: cn(), theme-context, lesson-context                     │
          └──────────────────────────────────────────────────────────────────┘
```

### 1.4 Import Cycle Analysis

**Current Import Relationships (No Cycles Detected):**
- All dependencies flow downward (features → shared → lib)
- No circular imports identified

---

## 2. Proposed Module Map

### 2.1 Target Directory Structure

```
src/
├── features/
│   ├── editor/
│   │   ├── components/
│   │   │   ├── CodeRunner.tsx
│   │   │   ├── LightEditor.tsx
│   │   │   ├── Autocomplete.tsx
│   │   │   ├── StaticCode.tsx
│   │   │   ├── HintSystem.tsx
│   │   │   └── pyodide/
│   │   │       ├── PyodideProvider.tsx
│   │   │       ├── PyodidePreloader.tsx
│   │   │       └── PyodideStatus.tsx
│   │   ├── lib/
│   │   │   ├── pyodide-context.tsx
│   │   │   └── python-tokenizer.ts
│   │   └── index.ts
│   │
│   ├── lessons/
│   │   ├── components/
│   │   │   ├── LessonRenderer.tsx
│   │   │   └── LessonNav.tsx
│   │   ├── lib/
│   │   │   ├── lesson-context.tsx
│   │   │   ├── lessons.ts
│   │   │   ├── remark-code-meta.ts
│   │   │   └── rehype-code-blocks.ts
│   │   └── index.ts
│   │
│   ├── projects/
│   │   ├── components/
│   │   │   ├── ProjectWorkspace.tsx
│   │   │   ├── ProjectEditor.tsx
│   │   │   ├── ProjectOutput.tsx
│   │   │   └── ProjectInstructions.tsx
│   │   └── index.ts
│   │
│   ├── progress/
│   │   ├── hooks/
│   │   │   └── use-progress.ts
│   │   ├── lib/
│   │   │   ├── cloud-progress.ts
│   │   │   └── progress.ts
│   │   └── index.ts
│   │
│   ├── auth/
│   │   ├── components/
│   │   │   └── AuthButton.tsx
│   │   ├── lib/
│   │   │   └── auth-context.tsx
│   │   └── index.ts
│   │
│   └── navigation/
│       ├── components/
│       │   ├── ProgressSidebar.tsx
│       │   ├── Dashboard.tsx
│       │   └── StatsBar.tsx
│       └── index.ts
│
├── shared/
│   ├── ui/
│   │   ├── Button.tsx
│   │   ├── Card.tsx
│   │   ├── Input.tsx
│   │   ├── ThemeToggle.tsx
│   │   ├── ErrorBoundary.tsx
│   │   ├── ResizableDivider.tsx
│   │   ├── MeridianLogo.tsx
│   │   └── index.ts
│   │
│   ├── lib/
│   │   ├── theme-context.tsx
│   │   └── utils.ts
│   │
│   └── index.ts
│
├── lib/
│   └── supabase/
│       ├── client.ts
│       ├── server.ts
│       └── middleware.ts
│
├── app/                    # Next.js App Router (unchanged)
└── content/               # Curriculum content (unchanged)
```

---

## 3. Module Boundary Rules

### 3.1 Import Rules Matrix

| From Module | Can Import | Cannot Import |
|-------------|-----------|---------------|
| `features/editor` | `shared/*`, `lib/supabase` | Other features |
| `features/lessons` | `shared/*`, `features/editor` (public API) | `projects`, `auth` |
| `features/projects` | `shared/*`, `features/editor`, `features/progress` | `lessons`, `auth` |
| `features/progress` | `shared/*`, `features/auth`, `lib/supabase` | `editor`, `lessons`, `projects` |
| `features/auth` | `shared/*`, `lib/supabase` | All other features |
| `features/navigation` | `shared/*`, `features/progress`, `features/auth` | `editor`, `lessons`, `projects` |
| `shared/*` | `lib/*` | All features |
| `lib/*` | Nothing | Everything |
| `app/*` | All features (public APIs), `shared/*`, `lib/*` | Internal feature modules |

### 3.2 Public API Exports

Each feature has a barrel `index.ts` that exports only the public API. Internal components are not exported.

---

## 4. Migration Order

### Phase 1: Shared Infrastructure
1. Move UI primitives to `src/shared/ui/`
2. Move `utils.ts`, `theme-context.tsx` to `src/shared/lib/`
3. Create barrel exports

### Phase 2: Editor Feature
1. Move `python-tokenizer.ts`, `pyodide-context.tsx` to `features/editor/lib/`
2. Move editor components to `features/editor/components/`
3. Create barrel export

### Phase 3: Auth Feature
1. Move `auth-context.tsx` to `features/auth/lib/`
2. Move `AuthButton.tsx` to `features/auth/components/`

### Phase 4: Progress Feature
1. Move progress utilities to `features/progress/lib/`
2. Move `use-progress.ts` to `features/progress/hooks/`

### Phase 5: Lessons Feature
1. Move lesson utilities to `features/lessons/lib/`
2. Move `LessonRenderer.tsx`, `LessonNav.tsx` to `features/lessons/components/`

### Phase 6: Projects Feature
1. Move project components to `features/projects/components/`

### Phase 7: Navigation Feature
1. Move navigation components to `features/navigation/components/`

### Phase 8: Update App Layer
1. Update all app imports to use feature public APIs

---

## 5. Anticipated Challenges

1. **CodeRunner Coupling**: Uses `useLessonContext` - consider prop drilling instead
2. **TypeScript Path Aliases**: All `@/` imports need updating
3. **Test File Migration**: Move test files with components
4. **Storybook Files**: Move story files with components

---

## 6. Agent Assignments

| Agent | Scope | Files |
|-------|-------|-------|
| Agent 2: Infra | Create folder structure, lint rules, tsconfig paths | Config files |
| Agent 3: Editor | `CodeRunner`, `LightEditor`, `pyodide-*`, `Autocomplete`, `StaticCode`, `HintSystem` | 10 files |
| Agent 4: Projects | `ProjectWorkspace`, `ProjectEditor`, `ProjectOutput`, `ProjectInstructions` | 4 files |
| Agent 5: Lessons | `LessonRenderer`, `LessonNav`, remark/rehype plugins, `lesson-context`, `lessons.ts` | 6 files |
| Agent 6: Auth | `auth-context`, `AuthButton` | 2 files |
| Agent 7: Shared | UI primitives, `utils.ts`, `theme-context`, `ErrorBoundary`, `ResizableDivider`, `MeridianLogo` | 10 files |
| Agent 8: QA | Validate imports, run tests, check for regressions | All files |
